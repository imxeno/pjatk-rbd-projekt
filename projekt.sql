-- STRUKTURA BAZY DANYCH

CREATE TABLE TYPPRZEDMIOTU (
    ID INT NOT NULL,
    NAZWA VARCHAR(64) NOT NULL,
    OPIS VARCHAR(255) NOT NULL,
    PRIMARY KEY (ID)
    );

CREATE TABLE KLASAPOSTACI (
    ID INT NOT NULL,
    NAZWA VARCHAR(64) NOT NULL,
    OPIS VARCHAR(255) NOT NULL,
    PRIMARY KEY (ID)
    );

CREATE TABLE GRACZ (
    ID INT NOT NULL,
    LOGIN VARCHAR(32) NOT NULL,
    HASLO CHAR(64) NOT NULL,
    EMAIL VARCHAR(345) NOT NULL,
    IP_REJESTRACJI VARCHAR(15) NOT NULL,
    IP_LOGOWANIA VARCHAR(15) DEFAULT NULL,
    POZIOM_GM INT NOT NULL,
    PRIMARY KEY (ID)
    );

CREATE TABLE GILDIA (
    ID INT NOT NULL,
    NAZWA VARCHAR(32) NOT NULL,
    POZIOM INT NOT NULL,
    ZALOZYCIEL_ID INT NOT NULL,
    PRIMARY KEY (ID)
    );

CREATE TABLE POSTAC (
    ID INT NOT NULL,
    NICK VARCHAR(32) NOT NULL,
    GRACZ_ID INT NOT NULL,
    KLASA_ID INT NOT NULL,
    POZIOM INT NOT NULL,
    GILDIA_ID INT DEFAULT NULL,
    PRIMARY KEY (ID),
    CONSTRAINT GILDIA_ID_FK FOREIGN KEY (GILDIA_ID) REFERENCES GILDIA (ID),
    CONSTRAINT GRACZ_ID_FK FOREIGN KEY (GRACZ_ID) REFERENCES GRACZ (ID),
    CONSTRAINT KLASA_ID_FK FOREIGN KEY (KLASA_ID) REFERENCES KLASAPOSTACI (ID)
    );

CREATE TABLE PRZEDMIOT (
    ID INT NOT NULL,
    NAZWA VARCHAR(64) DEFAULT NULL,
    TYP_ID INT DEFAULT NULL,
    RZADKOSC INT DEFAULT NULL,
    MNOZNIK INT DEFAULT NULL,
    PRIMARY KEY (ID),
    CONSTRAINT TYP_ID_FK FOREIGN KEY (TYP_ID) REFERENCES TYPPRZEDMIOTU (ID)
    );

CREATE TABLE EKWIPUNEK (
    POSTAC_ID INT NOT NULL,
    PRZEDMIOT_ID INT NOT NULL,
    ILOSC INT DEFAULT NULL,
    PRIMARY KEY (POSTAC_ID,PRZEDMIOT_ID),
    CONSTRAINT POSTAC_ID_FK FOREIGN KEY (POSTAC_ID) REFERENCES POSTAC (ID),
    CONSTRAINT PRZEDMIOT_ID_FK FOREIGN KEY (PRZEDMIOT_ID) REFERENCES PRZEDMIOT (ID)
    );

ALTER TABLE GILDIA ADD
    CONSTRAINT ZALOZYCIEL_ID_FK FOREIGN KEY (ZALOZYCIEL_ID) REFERENCES POSTAC (ID);

-- PRZYKŁADOWE DANE

INSERT INTO TYPPRZEDMIOTU (ID, NAZWA, OPIS) VALUES (1, 'Broń główna', 'Główna broń używana przez bohaterów.');
INSERT INTO TYPPRZEDMIOTU (ID, NAZWA, OPIS) VALUES (2, 'Zbroja', 'Pancerz postaci.');
INSERT INTO TYPPRZEDMIOTU (ID, NAZWA, OPIS) VALUES (3, 'Przedmiot użytkowy', 'Przedmiot, który można użyć poprzez podwójne kliknięcie.');

INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (1, 'Eliksir życia', 3, 0, 300);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (4, 'Loopuster', 1, 5, 100);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (3, 'Skyabona', 1, 3, 50);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (9, 'Różdzka wieków', 1, 1, 50);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (5, 'Łuk Poszukiwacza Przygód', 1, 0, 30);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (2, 'Miecz Poszukiwacza Przygód', 1, 0, 30);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (6, 'Łuk Gladiatora', 1, 4, 80);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (7, 'Skrzydło Diabła', 1, 5, 110);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (8, 'Różdzka Poszukiwacza Przygód', 1, 0, 30);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (10, 'Berło Kertosa', 1, 5, 120);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (11, 'Szata Poszukiwacza Przygód', 2, 0, 50);
INSERT INTO PRZEDMIOT (ID, NAZWA, TYP_ID, RZADKOSC, MNOZNIK) VALUES (12, 'Szata Testowa', 2, 5, 100);

INSERT INTO KLASAPOSTACI (ID, NAZWA, OPIS) VALUES (1, 'Wojownik', 'Postać walcząca wręcz.');
INSERT INTO KLASAPOSTACI (ID, NAZWA, OPIS) VALUES (2, 'Łucznik', 'Postać strzelająca z łuku.');
INSERT INTO KLASAPOSTACI (ID, NAZWA, OPIS) VALUES (3, 'Mag', 'Postać atakująca magią.');

INSERT INTO GRACZ (ID, LOGIN, HASLO, EMAIL, IP_REJESTRACJI, IP_LOGOWANIA, POZIOM_GM) VALUES (1, 'admin', 'admin', 'admin@serwergry.pl', '127.0.0.1', '127.0.0.1', 10);
INSERT INTO GRACZ (ID, LOGIN, HASLO, EMAIL, IP_REJESTRACJI, IP_LOGOWANIA, POZIOM_GM) VALUES (2, 'xeno', 'xeno', 'xeno@xeno.yt', '10.0.0.2', '10.0.0.2', 0);

INSERT INTO POSTAC (ID, NICK, GRACZ_ID, KLASA_ID, POZIOM, GILDIA_ID) VALUES (1, 'Admin', 1, 1, 99, DEFAULT);
INSERT INTO POSTAC (ID, NICK, GRACZ_ID, KLASA_ID, POZIOM, GILDIA_ID) VALUES (2, 'Xeno', 2, 2, 90, DEFAULT);
INSERT INTO POSTAC (ID, NICK, GRACZ_ID, KLASA_ID, POZIOM, GILDIA_ID) VALUES (3, 'Test', 2, 3, 15, DEFAULT);

INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 1, 99);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 2, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 3, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 4, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 5, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 6, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 7, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 8, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 9, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 10, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 11, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (1, 12, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (2, 1, 14);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (2, 5, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (2, 7, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (2, 11, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (2, 12, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (3, 1, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (3, 11, 1);
INSERT INTO EKWIPUNEK (POSTAC_ID, PRZEDMIOT_ID, ILOSC) VALUES (3, 8, 1);

INSERT INTO GILDIA (ID, NAZWA, POZIOM, ZALOZYCIEL_ID) VALUES (1, 'Pierwsza gildia na serwerze', 1, 2);

UPDATE POSTAC SET GILDIA_ID = 1 WHERE ID = 2;
UPDATE POSTAC SET GILDIA_ID = 1 WHERE ID = 3;

-- ZAPYTANIA PODSTAWOWE

--- Wybierz wszystkie maile graczy bez powtórzeń (do mass mailingu).
SELECT DISTINCT EMAIL FROM GRACZ;

--- Wybierz wszystkie postacie gracza o ID 2.
SELECT * FROM POSTAC WHERE GRACZ_ID = 2;

--- Wybierz ID postaci które posiadają przedmiot o ID 11.
SELECT POSTAC_ID FROM EKWIPUNEK WHERE PRZEDMIOT_ID = 11;

-- ZAPYTANIA Z JOINAMI

--- Pokaz nazwy wszystkich postacie wraz z poziomem GM gracza, który je posiada.

SELECT NICK, POZIOM_GM FROM POSTAC INNER JOIN GRACZ ON GRACZ_ID = GRACZ.ID;

--- Pokaz nazwy i ilości przedmiotów w ekwipunku postaci o nicku Xeno. 

SELECT POSTAC.NICK, PRZEDMIOT.NAZWA, EKWIPUNEK.ILOSC FROM EKWIPUNEK INNER JOIN PRZEDMIOT ON EKWIPUNEK.PRZEDMIOT_ID = PRZEDMIOT.ID INNER JOIN POSTAC on EKWIPUNEK.POSTAC_ID = POSTAC.ID;

--- Pokaz nazwę wszystkich przedmiotów wraz z nazwą ich typu.

SELECT PRZEDMIOT.NAZWA, TYPPRZEDMIOTU.NAZWA FROM PRZEDMIOT INNER JOIN TYPPRZEDMIOTU on PRZEDMIOT.TYP_ID = TYPPRZEDMIOTU.ID;

-- ZAPYTANIA GRUPOWANE

-- Wybierz liczbe postaci dla kazdego loginu gracza.

SELECT GRACZ.LOGIN, COUNT(POSTAC.ID) FROM GRACZ INNER JOIN POSTAC ON GRACZ.ID = POSTAC.GRACZ_ID GROUP BY GRACZ.LOGIN;

-- Wybierz liczbę przedmiotów dla kazdego typu, posortuj malejąco.

SELECT TYPPRZEDMIOTU.NAZWA, COUNT(PRZEDMIOT.ID) FROM TYPPRZEDMIOTU INNER JOIN PRZEDMIOT ON TYPPRZEDMIOTU.ID = PRZEDMIOT.TYP_ID GROUP BY TYPPRZEDMIOTU.NAZWA  ORDER BY COUNT(PRZEDMIOT.ID) DESC;

-- Wybierz liczbę postaci w gildii. Uwzglednij postacie bez gildii.

SELECT COUNT(NVL(P.GILDIA_ID, 0)), NVL(G.NAZWA, '[nie jest członkiem gildii]') FROM POSTAC P FULL JOIN GILDIA G on P.GILDIA_ID = G.ID GROUP BY G.NAZWA;

-- ZAPYTANIA ZAGNIEŻDZONE

--- Wybierz przedmioty o największym mnozniku.

SELECT PRZEDMIOT.NAZWA FROM PRZEDMIOT WHERE PRZEDMIOT.MNOZNIK = (SELECT MAX(MNOZNIK) AS M FROM PRZEDMIOT);

--- Wybierz przedmioty o najmniejszym i najwięszym mnozniku.

(SELECT PRZEDMIOT.NAZWA FROM PRZEDMIOT WHERE PRZEDMIOT.MNOZNIK = (SELECT MAX(MNOZNIK) AS M FROM PRZEDMIOT))
UNION
(SELECT PRZEDMIOT.NAZWA FROM PRZEDMIOT WHERE PRZEDMIOT.MNOZNIK = (SELECT MIN(MNOZNIK) AS M FROM PRZEDMIOT));

--- Wybierz nicki zalozycieli gildii, które mają w nazwie frazę "Pierwsza".

SELECT POSTAC.NICK FROM POSTAC WHERE POSTAC.ID = (SELECT ZALOZYCIEL_ID FROM GILDIA WHERE NAZWA LIKE '%Pierwsza%');
